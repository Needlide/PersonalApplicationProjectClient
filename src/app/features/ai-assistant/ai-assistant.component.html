@if (!isOpen()) {
<button
  mat-fab
  color="primary"
  class="chat-fab"
  (click)="toggleChat()"
  [@fadeIn]
>
  <mat-icon>smart_toy</mat-icon>
</button>
}

<!-- Chat Window -->
@if (isOpen()) {
<div class="chat-window" [@slideIn]>
  <!-- Header -->
  <div class="chat-header">
    <div class="flex items-center gap-2">
      <mat-icon>smart_toy</mat-icon>
      <div>
        <h3 class="text-sm font-semibold">Event Assistant</h3>
        <p class="text-xs opacity-90">Ask me anything about your events</p>
      </div>
    </div>
    <button mat-icon-button (click)="toggleChat()">
      <mat-icon>close</mat-icon>
    </button>
  </div>

  <!-- Messages -->
  <div class="chat-messages" #messagesContainer>
    @for (message of messages(); track message.timestamp) {
    <div
      class="message"
      [class.message-user]="message.role === 'user'"
      [class.message-assistant]="message.role === 'assistant'"
    >
      @if (message.role === 'assistant') {
      <mat-icon class="message-icon">smart_toy</mat-icon>
      }
      <div class="message-content">
        <p class="whitespace-pre-wrap">{{ message.content }}</p>
        <span class="message-time">
          {{ message.timestamp | date : "short" }}
        </span>
      </div>
    </div>
    } @if (isLoading()) {
    <div class="message message-assistant">
      <mat-spinner diameter="20"></mat-spinner>
      <span class="ml-2 text-sm text-gray-500">Thinking...</span>
    </div>
    }
  </div>

  <!-- Quick Actions -->
  @if (messages().length === 1) {
  <div class="quick-actions">
    <button
      mat-stroked-button
      (click)="askPredefined('What events am I attending this week?')"
      class="quick-action-btn"
    >
      <mat-icon>event</mat-icon>
      This week
    </button>
    <button
      mat-stroked-button
      (click)="askPredefined('When is my next event?')"
      class="quick-action-btn"
    >
      <mat-icon>schedule</mat-icon>
      Next event
    </button>
    <button
      mat-stroked-button
      (click)="askPredefined('List all events I organize.')"
      class="quick-action-btn"
    >
      <mat-icon>manage_accounts</mat-icon>
      My events
    </button>
  </div>
  }

  <!-- Input -->
  <div class="chat-input">
    <mat-form-field appearance="outline" class="w-full">
      <input
        matInput
        [formControl]="questionControl"
        (keyup.enter)="sendQuestion()"
        placeholder="Ask a question..."
        [disabled]="isLoadingContext()"
      />
    </mat-form-field>
    <button
      mat-icon-button
      color="primary"
      (click)="sendQuestion()"
      [disabled]="!questionControl.value || isLoading() || isLoadingContext()"
    >
      <mat-icon>send</mat-icon>
    </button>
  </div>
</div>
}
